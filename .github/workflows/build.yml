name: Build

on:
  push:
    branches:
      - 'main'

jobs:
  kernel:
    runs-on: ubuntu-latest
    name: Build
    strategy:
      matrix:
        project:
          - preinstalled-desktop
          - preinstalled-server
        suite:
          - bookworm
          - trixie
    steps:
      - name: Get more disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get upgrade -y && sudo apt-get install debootstrap qemu-utils qemu-efi-aarch64 qemu-system-arm xz-utils -y
          sudo docker run --privileged --rm tonistiigi/binfmt --install all

      - name: Build
        shell: bash
        run: |
          sudo debootstrap ${{ matrix.suite == 'bookworm' && '12' || matrix.suite == 'trixie' && '13' }} --arch=arm64 --foreign debian http://deb.debian.org/debian/
          echo "nameserver 8.8.8.8" | sudo tee debian/etc/resolv.conf
          sudo cat <<EOF > debian/stage2.sh
          #!/bin/bash
          /debootstrap/debootstrap --second-stage
          cat <<EOT > /etc/apt/sources.list
          deb http://deb.debian.org/debian/ bullseye main contrib non-free
          deb-src http://deb.debian.org/debian/ bullseye main contrib non-free
          deb http://deb.debian.org/debian/ bullseye-updates main contrib non-free
          deb-src http://deb.debian.org/debian/ bullseye-updates main contrib non-free
          deb http://security.debian.org/debian-security bullseye-security main contrib non-free
          deb-src http://security.debian.org/debian-security bullseye-security main contrib non-free
          deb http://deb.debian.org/debian/ bullseye-backports main contrib non-free
          deb-src http://deb.debian.org/debian/ bullseye-backports main contrib non-free
          EOT
          apt-get update
          apt-get install locales dialog tzdata -y
          echo "Etc/GMT" > /etc/timezone
          sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
          echo 'LANG="en_US.UTF-8"'>/etc/default/locale
          dpkg-reconfigure --frontend=noninteractive locales && \
          update-locale LANG=en_US.UTF-8
          ENV LANG en_US.UTF-8
          ENV LANGUAGE en_US.UTF-8
          ENV LC_ALL en_US.UTF-8
          useradd -m -s /bin/bash debian
          usermod -aG sudo debian
          echo 'debian:debian'|chpasswd
          apt-get install vim openssh-server ntpdate sudo ifupdown net-tools udev iputils-ping wget dosfstools unzip binutils libatomic1 -y
          cat <<EOT > /etc/network/interfaces
          allow-hotplug eth0
          iface eth0 inet dhcp
          EOT
          EOF
          sudo chmod 755 debian/stage2.sh
          sudo chroot debian ./stage2.sh
          rm debian/stage2.sh
          cd debian && sudo tar cvf ../debian-${{ matrix.suite == 'bookworm' && '12' || matrix.suite == 'trixie' && '13' }}-${{ matrix.project }}-arm64-rootfs.tar .
          cd ..
          sudo xz -9 debian-${{ matrix.suite == 'bookworm' && '12' || matrix.suite == 'trixie' && '13' }}-${{ matrix.project }}-arm64-rootfs.tar
          sudo chmod 777 *.xz
      - name: Upload
        uses: actions/upload-artifact@v4.3.1
        with:
          name: debian-${{ matrix.suite == 'bookworm' && '12' || matrix.suite == 'trixie' && '13' }}-${{ matrix.project }}-arm64-rootfs
          path: ./build/debian-${{ matrix.suite == 'bookworm' && '12' || matrix.suite == 'trixie' && '13' }}-${{ matrix.project }}-arm64.rootfs.tar.xz
          if-no-files-found: error
